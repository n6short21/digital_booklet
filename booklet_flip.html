<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Flip Booklet (Click Only)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/page-flip@2.0.7/dist/css/page-flip.css" />
<style>
  :root{ --bg:#0f172a; --panel:#111827; --muted:#9ca3af; --text:#e5e7eb; --accent:#60a5fa; }
  *{ box-sizing:border-box }
  html,body{ height:100%; margin:0; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial }

  .app{ min-height:100svh; display:grid; grid-template-rows:auto 1fr auto; gap:8px }
  header{ background:var(--panel); padding:8px 12px; border-bottom:1px solid #1f2937; display:flex; align-items:center; justify-content:space-between }
  .meta{ color:var(--muted); font-size:13px }

  .stage-wrap{ position:relative; display:grid; place-items:center; padding:10px }
  #flipRoot{
    position:relative;
    width:min(1200px,96vw);
    height:clamp(420px, calc(100svh - 180px), 900px); /* more conservative for iframes/mobiles */
    background:#0b1220; border:1px solid #1f2937; border-radius:12px;
    box-shadow:0 10px 30px rgba(0,0,0,.4), inset 0 0 0 1px #1f2937;
    display:flex; align-items:center; justify-content:center; overflow:hidden;
  }
  /* Disable interaction with the flip DOM itself (no drag) */
  #flipRoot #book{ pointer-events:none; }

  /* Click zones on top that handle page turning */
  .click-zone{
    position:absolute; inset:0; display:grid; grid-template-columns:1fr 1fr; z-index:3;
  }
  .zone{ height:100%; }
  .zone-left{ cursor:w-resize; }
  .zone-right{ cursor:e-resize; }

  /* Under-document controls */
  .under-controls{
    display:flex; justify-content:center; gap:10px; padding:6px 10px 16px;
  }
  .btn{
    background:#0b1220; border:1px solid #1f2937; color:var(--text);
    padding:10px 14px; border-radius:10px; font-weight:600; cursor:pointer;
  }
  .btn:hover{ border-color:var(--accent) }
  .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap }

  footer{ background:var(--panel); padding:8px 12px; border-top:1px solid #1f2937; display:flex; align-items:center; justify-content:space-between }
  .status{ color:var(--muted); font-size:14px }

  @media (max-width:900px){
    #flipRoot{ height:clamp(360px, calc(100svh - 220px), 780px) }
  }
  @media (max-width:600px){
    #flipRoot{ height:clamp(320px, calc(100svh - 240px), 680px) }
  }
</style>
</head>
<body>
<div class="app">
  <header>
    <div class="row"><strong>Flip Booklet</strong><span class="meta"> · click left/right to turn</span></div>
    <div class="row">
      <span class="meta" id="pageLabel">—</span>
      <span class="meta" id="zoomLabel">100%</span>
    </div>
  </header>

  <div class="stage-wrap">
    <div id="flipRoot">
      <div id="book"></div>
      <!-- Transparent overlay to catch clicks; prevents drag/swipe -->
      <div class="click-zone" aria-hidden="true">
        <div class="zone zone-left" id="zoneLeft"></div>
        <div class="zone zone-right" id="zoneRight"></div>
      </div>
      <div class="status" id="status">Loading…</div>
    </div>
  </div>

  <div class="under-controls">
    <button class="btn" id="prevBtn">⟵ Prev</button>
    <button class="btn" id="fitBtn">Fit</button>
    <button class="btn" id="zoomOutBtn">–</button>
    <button class="btn" id="zoomInBtn">+</button>
    <button class="btn" id="nextBtn">Next ⟶</button>
  </div>

  <footer>
    <span class="meta">Tip: add <code>?src=your.pdf</code> or a direct PDF URL</span>
    <span class="meta">Optimized for mobile & tablets</span>
  </footer>
</div>

<!-- PDF.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<!-- StPageFlip -->
<script src="https://cdn.jsdelivr.net/npm/page-flip@2.0.7/dist/js/page-flip.browser.min.js"></script>
<script>
(function(){
  const q = new URLSearchParams(location.search);
  const DEFAULT_SRC = q.get("src") || "your.pdf";

  const flipRoot = document.getElementById("flipRoot");
  const bookEl   = document.getElementById("book");
  const statusEl = document.getElementById("status");
  const pageLabel= document.getElementById("pageLabel");
  const zoomLabel= document.getElementById("zoomLabel");

  const prevBtn  = document.getElementById("prevBtn");
  const nextBtn  = document.getElementById("nextBtn");
  const fitBtn   = document.getElementById("fitBtn");
  const zoomInBtn= document.getElementById("zoomInBtn");
  const zoomOutBtn=document.getElementById("zoomOutBtn");
  const zoneLeft = document.getElementById("zoneLeft");
  const zoneRight= document.getElementById("zoneRight");

  pdfjsLib.GlobalWorkerOptions.workerSrc =
    "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";

  let pdfDoc = null, pageFlip = null, totalPages = 0;
  let basePagePx = { w: 800, h: 1131 }; // updated from first rendered page
  let zoom = 1.0;

  function setStatus(s){ statusEl.textContent = s || ""; }
  function setZoom(z){
    zoom = Math.min(2.2, Math.max(0.6, z));
    zoomLabel.textContent = Math.round(zoom*100) + "%";
    if (pageFlip){
      pageFlip.update({
        width: Math.round(basePagePx.w * zoom),
        height: Math.round(basePagePx.h * zoom),
      });
    }
  }
  function isPortraitMode(){
    // Decide single page vs spread by container width (safer in iframes than window width)
    return flipRoot.clientWidth < 720; // threshold tuned for tablets/phones/iframes
  }
  function bestFitZoom(){
    const pad = 24;
    const W = flipRoot.clientWidth - pad;
    const H = flipRoot.clientHeight - pad;
    const twoPage = !isPortraitMode();
    const needW = (twoPage ? basePagePx.w*2 : basePagePx.w);
    const needH = basePagePx.h;
    const z = Math.min(W / needW, H / needH);
    setZoom(z);
  }
  function onFlip(e){
    const idx = e.data; // 0-based
    const pageNo = idx + 1;
    if (pageFlip.getSettings().usePortrait || isPortraitMode()){
      pageLabel.textContent = `Page ${pageNo} / ${totalPages}`;
    } else {
      const right = Math.min(pageNo + 1, totalPages);
      pageLabel.textContent = `Pages ${pageNo}–${right} / ${totalPages}`;
    }
  }

  async function renderPdfPageToImage(pdf, n){
    const page = await pdf.getPage(n);
    // Lighter render scale on small screens to avoid memory issues
    const small = isPortraitMode();
    const device = Math.min(2, (window.devicePixelRatio || 1));
    const scale = small ? 1.2 * device : 1.5 * device;
    const viewport = page.getViewport({ scale });
    const canvas = document.createElement("canvas");
    const ctx = canvas.getContext("2d", { willReadFrequently:false });
    canvas.width = Math.floor(viewport.width);
    canvas.height = Math.floor(viewport.height);
    await page.render({ canvasContext: ctx, viewport }).promise;
    if (n === 1) basePagePx = { w: canvas.width, h: canvas.height };
    return canvas.toDataURL("image/png");
  }

  async function loadPDF(url){
    try{
      setStatus("Loading PDF…");
      // Pre-fetch to detect HTML “preview” pages and to avoid some CORS headaches
      const res = await fetch(url, { credentials:"omit" });
      if (!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}`);
      const ct = (res.headers.get("content-type") || "").toLowerCase();
      const buf = await res.arrayBuffer();
      const isPdf = ct.includes("application/pdf");
      const startsHtml = new TextDecoder("utf-8").decode(new Uint8Array(buf.slice(0,1))) === "<";
      if (!isPdf && startsHtml) throw new Error("Got HTML instead of a PDF (preview/interstitial). Use a direct PDF URL.");

      const loadingTask = pdfjsLib.getDocument({ data: buf });
      pdfDoc = await loadingTask.promise;
      totalPages = pdfDoc.numPages;

      setStatus("Rendering pages…");
      const images = [];
      for (let i = 1; i <= totalPages; i++){
        images.push(await renderPdfPageToImage(pdfDoc, i));
        if (i % 4 === 0) setStatus(`Rendering pages… ${i}/${totalPages}`);
      }

      // Reset and create PageFlip
      bookEl.innerHTML = "";
      pageFlip = new St.PageFlip(bookEl, {
        width: basePagePx.w,
        height: basePagePx.h,
        size: "stretch",
        showCover: true,
        maxShadowOpacity: 0.3,
        mobileScrollSupport: true,
        usePortrait: isPortraitMode()
      });

      // Load all images (most reliable)
      pageFlip.loadFromImages(images);

      // Fit + labels
      pageFlip.on("flip", onFlip);
      onFlip({ data: pageFlip.getCurrentPageIndex() });
      bestFitZoom();
      setStatus("");

      // Click-only navigation (no drag/swipe)
      const goPrev = ()=> pageFlip && pageFlip.flipPrev();
      const goNext = ()=> pageFlip && pageFlip.flipNext();
      prevBtn.onclick = goPrev;
      nextBtn.onclick = goNext;
      zoneLeft.onclick = goPrev;
      zoneRight.onclick = goNext;

      // Zoom controls
      fitBtn.onclick = ()=> bestFitZoom();
      zoomInBtn.onclick = ()=> setZoom(zoom + 0.1);
      zoomOutBtn.onclick = ()=> setZoom(zoom - 0.1);

      // Prevent touch scrolling hijacking on overlay (for some site builders)
      [zoneLeft, zoneRight].forEach(z=>{
        z.addEventListener("touchstart", e=> e.preventDefault(), {passive:false});
        z.addEventListener("touchmove",  e=> e.preventDefault(), {passive:false});
      });

      // Persist src in URL
      history.replaceState(null, "", `?src=${encodeURIComponent(url)}`);

    }catch(err){
      console.error(err);
      setStatus("Failed to load PDF (check link/CORS/sharing).");
      alert(err.message);
    }
  }

  function handleResize(){
    if (!pageFlip) return;
    pageFlip.update({ usePortrait: isPortraitMode() });
    bestFitZoom();
  }

  // Recalculate on resize & orientation changes (helps tablets/iframes)
  window.addEventListener("resize", handleResize);
  window.addEventListener("orientationchange", ()=> setTimeout(handleResize, 100));

  // Initial load
  loadPDF(DEFAULT_SRC);
})();
</script>
</body>
</html>
