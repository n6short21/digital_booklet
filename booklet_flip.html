<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Flip Booklet</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/page-flip@2.0.7/dist/css/page-flip.css" />
<style>
  :root{--bg:#0f172a;--panel:#111827;--muted:#9ca3af;--text:#e5e7eb;--accent:#60a5fa}
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;overflow:hidden}

  .app{height:100%;display:grid;grid-template-rows:auto 1fr}
  header{background:var(--panel);border-bottom:1px solid #1f2937;padding:8px 12px;display:flex;justify-content:space-between;align-items:center}
  .muted{color:var(--muted);font-size:13px}

  .stage{position:relative;height:100%;padding:8px;display:flex;align-items:center;justify-content:center}
  /* Outer container */
  #flipRoot{
    position:relative;width:100%;height:100%;max-width:1100px;margin:auto;
    border:1px solid #1f2937;border-radius:12px;background:#0b1220;
    overflow:hidden;display:flex;align-items:center;justify-content:center
  }
  /* Inner frame adds safe padding so shadows/margins never clip */
  #frame{
    position:relative; width:100%; height:100%;
    padding:16px 16px 72px 16px;             /* top/right/bottom/left safe area */
  }
  /* PageFlip host sits inside the padded frame */
  #bookWrap{
    position:absolute; inset:16px 16px 72px 16px;  /* keep in sync with #frame padding */
    display:flex; align-items:center; justify-content:center;
  }

  #book{pointer-events:none} /* no drag/swipe; clicks only */
  #status{position:absolute;left:20px;top:14px;color:#9ca3af;font-size:13px}

  /* Click zones (left/right) */
  .nav-overlay{position:absolute;inset:16px 16px 72px 16px;z-index:3;display:grid;grid-template-columns:1fr 1fr}
  .zone{height:100%}
  .left{cursor:w-resize}
  .right{cursor:e-resize}

  /* Dock lives inside frame bottom; we measure it for fit */
  .dock{
    position:absolute; left:16px; right:16px; bottom:16px; z-index:4;
    display:flex;flex-wrap:wrap;gap:6px;justify-content:center;
    background:rgba(17,24,39,.82);backdrop-filter:blur(6px);
    border:1px solid #1f2937;border-radius:10px;padding:6px 8px
  }
  .btn{background:#0b1220;border:1px solid #1f2937;color:var(--text);
       padding:6px 10px;border-radius:8px;font-weight:600;cursor:pointer}
  .btn:hover{border-color:var(--accent)}
  .btn[disabled]{opacity:.55;cursor:not-allowed}
  .field{display:inline-flex;align-items:center;gap:6px}
  .page{width:56px;padding:6px 8px;border-radius:8px;border:1px solid #1f2937;background:#0b1220;color:var(--text);text-align:center}
  .sep{width:1px;height:22px;background:#1f2937;margin:0 4px;border-radius:1px}
  .meta{color:#cbd5e1;font-size:12px}

  @media (max-width:640px){
    .stage{padding:6px}
    #frame{padding:12px 12px 76px 12px}
    #bookWrap{inset:12px 12px 76px 12px}
    .dock{left:12px;right:12px;bottom:12px;padding:6px}
    .page{width:48px}
  }
</style>
</head>
<body>
<div class="app">
  <header>
    <strong>Flip Booklet</strong>
    <span class="muted" id="pageLabel">—</span>
  </header>

  <div class="stage">
    <div id="flipRoot">
      <div id="frame">
        <div id="bookWrap"><div id="book"></div></div>
        <div id="status">Loading…</div>

        <!-- click-only navigation -->
        <div class="nav-overlay">
          <div class="zone left"  id="zoneLeft"></div>
          <div class="zone right" id="zoneRight"></div>
        </div>

        <!-- controls -->
        <div class="dock" id="dock">
          <button class="btn" id="firstBtn" title="First page">⟸</button>
          <button class="btn" id="prevBtn"  title="Previous">←</button>
          <span class="field">
            <span class="meta">Page</span>
            <input class="page" id="pageInput" value="1" inputmode="numeric" />
            <span class="meta">of <span id="pageCount">—</span></span>
          </span>
          <button class="btn" id="nextBtn"  title="Next">→</button>
          <button class="btn" id="lastBtn"  title="Last page">⟹</button>
          <span class="sep"></span>
          <button class="btn" id="fitBtn"     title="Fit to view">Fit</button>
          <button class="btn" id="zoomOutBtn" title="Zoom out">–</button>
          <button class="btn" id="zoomInBtn"  title="Zoom in">+</button>
          <span class="meta" id="zoomLabel">100%</span>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/page-flip@2.0.7/dist/js/page-flip.browser.min.js"></script>
<script>
(async ()=>{
  const qs=new URLSearchParams(location.search);
  const SRC=qs.get("src")||"your.pdf";

  const flipRoot=document.getElementById('flipRoot');
  const frame   =document.getElementById('frame');
  const bookWrap=document.getElementById('bookWrap');
  const bookEl  =document.getElementById('book');
  const statusEl=document.getElementById('status');
  const pageLabel=document.getElementById('pageLabel');
  const pageInput=document.getElementById('pageInput');
  const pageCount=document.getElementById('pageCount');
  const zoomLabel=document.getElementById('zoomLabel');

  const firstBtn=document.getElementById('firstBtn');
  const prevBtn =document.getElementById('prevBtn');
  const nextBtn =document.getElementById('nextBtn');
  const lastBtn =document.getElementById('lastBtn');
  const fitBtn  =document.getElementById('fitBtn');
  const zoomInBtn =document.getElementById('zoomInBtn');
  const zoomOutBtn=document.getElementById('zoomOutBtn');
  const zoneLeft=document.getElementById('zoneLeft');
  const zoneRight=document.getElementById('zoneRight');
  const dock    =document.getElementById('dock');

  pdfjsLib.GlobalWorkerOptions.workerSrc="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";

  let pdfDoc=null,pageFlip=null,total=0;
  let base={w:800,h:1131};
  let zoom=1.0;
  const DPR=Math.min(2,window.devicePixelRatio||1);
  const setStatus=s=>statusEl.textContent=s||"";
  const clamp=(v,min,max)=>Math.max(min,Math.min(max,v));

  function updatePager(curr){
    pageInput.value=String(curr);
    firstBtn.disabled=curr<=1;
    prevBtn.disabled =curr<=1;
    nextBtn.disabled =curr>=total;
    lastBtn.disabled =curr>=total;
    pageLabel.textContent=`Page ${curr} / ${total}`;
  }

  // Measure the *usable* area (inner frame minus dock height)
  function availableSize(){
    const r=bookWrap.getBoundingClientRect();
    const dockH = dock ? Math.ceil(dock.getBoundingClientRect().height) : 0;
    const topPad   = parseInt(window.getComputedStyle(frame).paddingTop)    || 0;
    const rightPad = parseInt(window.getComputedStyle(frame).paddingRight)  || 0;
    const botPad   = parseInt(window.getComputedStyle(frame).paddingBottom) || 0;
    const leftPad  = parseInt(window.getComputedStyle(frame).paddingLeft)   || 0;

    // we already inset bookWrap by these paddings, but we compute based on its rect
    const cw = Math.max(200, Math.floor(r.width));
    const ch = Math.max(200, Math.floor(r.height - dockH));
    return { cw, ch };
  }

  function setZoom(z){
    const {cw,ch}=availableSize();
    const fit=Math.min(cw/base.w, ch/base.h);
    const minZ=0.5*fit, maxZ=2.5*fit;
    zoom=Math.max(minZ, Math.min(maxZ, z));

    if(pageFlip){
      pageFlip.update({
        width:  Math.round(base.w*zoom),
        height: Math.round(base.h*zoom),
        usePortrait:true, showCover:false, size:"fixed"
      });
    }
    const pct=Math.round((zoom/fit)*100);
    zoomLabel.textContent=(Math.abs(zoom-fit)<0.01)?"Fit":`${pct}%`;
  }
  function bestFitZoom(){ setZoom(Number.POSITIVE_INFINITY); }

  async function renderPdfPageToImage(pdf, n){
    const page=await pdf.getPage(n);
    const viewport=page.getViewport({ scale:1.5*DPR });
    const c=document.createElement('canvas');
    c.width=viewport.width; c.height=viewport.height;
    await page.render({canvasContext:c.getContext('2d'),viewport}).promise;
    if(n===1) base={w:c.width,h:c.height};
    return c.toDataURL("image/png");
  }

  async function load(){
    try{
      setStatus("Loading PDF…");
      const res=await fetch(SRC,{credentials:"omit"});
      if(!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}`);
      const buf=await res.arrayBuffer();
      pdfDoc=await pdfjsLib.getDocument({data:buf}).promise;
      total=pdfDoc.numPages; pageCount.textContent=total;

      setStatus("Rendering pages…");
      const imgs=[];
      for(let i=1;i<=total;i++){
        imgs.push(await renderPdfPageToImage(pdfDoc,i));
        if(i%4===0) setStatus(`Rendering… ${i}/${total}`);
      }

      bookEl.innerHTML="";
      pageFlip=new St.PageFlip(bookEl,{
        width:base.w, height:base.h,
        usePortrait:true, showCover:false, size:"fixed",
        maxShadowOpacity:0.3, mobileScrollSupport:true
      });
      pageFlip.loadFromImages(imgs);
      pageFlip.on("flip", e=>updatePager(e.data+1));
      updatePager(1);

      bestFitZoom();
      setStatus("");

      // Pager
      firstBtn.onclick=()=>pageFlip.flip(0);
      prevBtn.onclick =()=>pageFlip.flipPrev();
      nextBtn.onclick =()=>pageFlip.flipNext();
      lastBtn.onclick =()=>pageFlip.flip(total-1);
      pageInput.addEventListener('keyup',e=>{
        if(e.key==='Enter'){ const n=clamp(parseInt(pageInput.value||"1",10)||1,1,total); pageFlip.flip(n-1); }
      });
      pageInput.addEventListener('blur',()=>{ const n=clamp(parseInt(pageInput.value||"1",10)||1,1,total); pageFlip.flip(n-1); });

      // Click zones
      zoneLeft.onclick =()=>pageFlip.flipPrev();
      zoneRight.onclick=()=>pageFlip.flipNext();

      // Zoom
      fitBtn.onclick    =()=>bestFitZoom();
      zoomInBtn.onclick =()=>setZoom(zoom+0.1);
      zoomOutBtn.onclick()=>setZoom(zoom-0.1);

      // Refit on resize/orientation/font settle
      const refit=()=>bestFitZoom();
      window.addEventListener('resize',refit);
      window.addEventListener('orientationchange',()=>setTimeout(refit,120));
      if(document.fonts && document.fonts.ready) document.fonts.ready.then(refit);

    }catch(err){
      console.error(err); setStatus("Failed to load PDF."); alert(err.message);
    }
  }

  await load();
})();
</script>
</body>
</html>
