<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Flip Booklet</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/page-flip@2.0.7/dist/css/page-flip.css" />
<style>
  :root{--bg:#0f172a;--panel:#111827;--muted:#9ca3af;--text:#e5e7eb;--accent:#60a5fa}
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;overflow:hidden}

  .app{height:100%;display:grid;grid-template-rows:auto 1fr}
  header{background:var(--panel);border-bottom:1px solid #1f2937;padding:8px 12px;display:flex;justify-content:space-between;align-items:center}
  .muted{color:var(--muted);font-size:13px}

  .stage{position:relative;height:100%;padding:8px;display:flex;align-items:center;justify-content:center}
  #flipRoot{position:relative;width:100%;height:100%;max-width:1100px;margin:auto;border:1px solid #1f2937;border-radius:12px;background:#0b1220;overflow:hidden;display:flex;align-items:center;justify-content:center}
  #book{pointer-events:none} /* no dragging; clicks only */
  #status{position:absolute;left:12px;top:10px;color:#9ca3af;font-size:13px}

  /* Click overlay to turn pages (left/right click zones) */
  .nav-overlay{position:absolute;inset:0;display:grid;grid-template-columns:1fr 1fr;z-index:3}
  .zone{height:100%}
  .left{cursor:w-resize}
  .right{cursor:e-resize}

  /* Controls dock: sits right under the page; on phones it tucks closer */
  .dock{position:absolute;left:8px;right:8px;bottom:8px;display:flex;flex-wrap:wrap;gap:6px;justify-content:center;
        background:rgba(17,24,39,.8);backdrop-filter:blur(6px);border:1px solid #1f2937;border-radius:10px;padding:6px 8px;z-index:4}
  .btn{background:#0b1220;border:1px solid #1f2937;color:var(--text);padding:6px 10px;border-radius:8px;font-weight:600;cursor:pointer}
  .btn:hover{border-color:var(--accent)}
  .btn[disabled]{opacity:.55;cursor:not-allowed}
  .field{display:inline-flex;align-items:center;gap:6px}
  .page{width:56px;padding:6px 8px;border-radius:8px;border:1px solid #1f2937;background:#0b1220;color:var(--text);text-align:center}
  .sep{width:1px;height:22px;background:#1f2937;margin:0 4px;border-radius:1px}
  .meta{color:#cbd5e1;font-size:12px}

  /* Phone tweaks: keep dock tight to the page; reduce padding */
  @media (max-width:640px){
    .stage{padding:6px}
    .dock{left:6px;right:6px;bottom:6px;padding:6px}
    .page{width:48px}
  }
</style>
</head>
<body>
<div class="app">
  <header>
    <strong>Flip Booklet</strong>
    <span class="muted" id="pageLabel">—</span>
  </header>

  <div class="stage">
    <div id="flipRoot">
      <div id="book"></div>
      <div id="status">Loading…</div>

      <!-- click-only navigation -->
      <div class="nav-overlay">
        <div class="zone left"  id="zoneLeft"></div>
        <div class="zone right" id="zoneRight"></div>
      </div>

      <!-- controls dock (Staples-style pager + zoom) -->
      <div class="dock" id="dock">
        <button class="btn" id="firstBtn">⟸</button>
        <button class="btn" id="prevBtn">←</button>
        <span class="field">
          <span class="meta">Page</span>
          <input class="page" id="pageInput" value="1" inputmode="numeric" />
          <span class="meta">of <span id="pageCount">—</span></span>
        </span>
        <button class="btn" id="nextBtn">→</button>
        <button class="btn" id="lastBtn">⟹</button>
        <span class="sep"></span>
        <button class="btn" id="fitBtn">Fit</button>
        <button class="btn" id="zoomOutBtn">–</button>
        <button class="btn" id="zoomInBtn">+</button>
        <span class="meta" id="zoomLabel">100%</span>
      </div>
    </div>
  </div>
</div>

<!-- libs -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/page-flip@2.0.7/dist/js/page-flip.browser.min.js"></script>
<script>
(async ()=>{
  const qs=new URLSearchParams(location.search);
  const SRC=qs.get("src")||"your.pdf";

  // UI elements
  const flipRoot = document.getElementById('flipRoot');
  const bookEl   = document.getElementById('book');
  const statusEl = document.getElementById('status');
  const pageLabel= document.getElementById('pageLabel');
  const pageInput= document.getElementById('pageInput');
  const pageCount= document.getElementById('pageCount');
  const zoomLabel= document.getElementById('zoomLabel');

  const firstBtn = document.getElementById('firstBtn');
  const prevBtn  = document.getElementById('prevBtn');
  const nextBtn  = document.getElementById('nextBtn');
  const lastBtn  = document.getElementById('lastBtn');
  const fitBtn   = document.getElementById('fitBtn');
  const zoomInBtn= document.getElementById('zoomInBtn');
  const zoomOutBtn=document.getElementById('zoomOutBtn');
  const zoneLeft = document.getElementById('zoneLeft');
  const zoneRight= document.getElementById('zoneRight');

  // pdf.js setup
  pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";

  // state
  let pdfDoc=null, pageFlip=null, total=0;
  let base={w:800,h:1131};  // updated from first render
  let zoom=1.0;

  const DPR = Math.min(2, window.devicePixelRatio || 1);
  const setStatus = s => statusEl.textContent = s || "";
  const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));

  function updatePager(curr){
    pageInput.value = String(curr);
    firstBtn.disabled = curr<=1;
    prevBtn.disabled  = curr<=1;
    nextBtn.disabled  = curr>=total;
    lastBtn.disabled  = curr>=total;
    pageLabel.textContent = `Page ${curr} / ${total}`;
  }

  function bestFitZoom(){
    // Fit ONE page into flipRoot (no inner scrollbars)
    const pad = 24;
    const cw = Math.max(200, flipRoot.clientWidth  - pad);
    const ch = Math.max(200, flipRoot.clientHeight - pad - 56); // leave a bit for the dock
    const z = Math.min(cw / base.w, ch / base.h);
    setZoom(z);
  }

  function setZoom(z){
    zoom = clamp(z, 0.5, 2.5);
    zoomLabel.textContent = Math.round(zoom*100)+"%";
    if (!pageFlip) return;
    pageFlip.update({
      width:  Math.round(base.w * zoom),
      height: Math.round(base.h * zoom),
      usePortrait: true,
      showCover: false,
      size: "fixed"
    });
  }

  async function renderPdfPageToImage(pdf, n){
    const page = await pdf.getPage(n);
    const viewport = page.getViewport({ scale: 1.5 * DPR });
    const c = document.createElement('canvas');
    c.width = viewport.width; c.height = viewport.height;
    await page.render({ canvasContext: c.getContext('2d'), viewport }).promise;
    if (n===1) base = { w: c.width, h: c.height };
    return c.toDataURL("image/png");
  }

  async function load(){
    try{
      setStatus("Loading PDF…");
      const res = await fetch(SRC, { credentials: "omit" });
      if (!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}`);
      const buf = await res.arrayBuffer();
      pdfDoc = await pdfjsLib.getDocument({ data: buf }).promise;
      total = pdfDoc.numPages; pageCount.textContent = total;

      setStatus("Rendering pages…");
      const imgs = [];
      for (let i=1;i<=total;i++){
        imgs.push(await renderPdfPageToImage(pdfDoc, i));
        if (i%4===0) setStatus(`Rendering… ${i}/${total}`);
      }

      // init PageFlip (animation is back)
      bookEl.innerHTML = "";
      pageFlip = new St.PageFlip(bookEl, {
        width: base.w, height: base.h,
        usePortrait: true, showCover: false,
        size: "fixed",
        maxShadowOpacity: 0.3,
        mobileScrollSupport: true
      });
      pageFlip.loadFromImages(imgs);
      pageFlip.on("flip", e => updatePager(e.data + 1));
      updatePager(1);
      bestFitZoom();
      setStatus("");

      // pager actions (Staples-like)
      firstBtn.onclick = ()=> pageFlip.flip(0);
      prevBtn.onclick  = ()=> pageFlip.flipPrev();
      nextBtn.onclick  = ()=> pageFlip.flipNext();
      lastBtn.onclick  = ()=> pageFlip.flip(total-1);

      pageInput.addEventListener('keyup', e=>{
        if (e.key==='Enter'){
          const n = clamp(parseInt(pageInput.value||"1",10)||1,1,total);
          pageFlip.flip(n-1);
        }
      });
      pageInput.addEventListener('blur', ()=>{
        const n = clamp(parseInt(pageInput.value||"1",10)||1,1,total);
        pageFlip.flip(n-1);
      });

      // click zones
      zoneLeft.onclick  = ()=> pageFlip.flipPrev();
      zoneRight.onclick = ()=> pageFlip.flipNext();

      // zoom
      fitBtn.onclick     = ()=> bestFitZoom();
      zoomInBtn.onclick  = ()=> setZoom(zoom + 0.1);
      zoomOutBtn.onclick = ()=> setZoom(zoom - 0.1);

      // keyboard (if iframe allows focus)
      window.addEventListener('keydown', e=>{
        if (document.activeElement === pageInput) return;
        if (e.key==='ArrowLeft')  prevBtn.click();
        if (e.key==='ArrowRight') nextBtn.click();
        if (e.key==='Home')       firstBtn.click();
        if (e.key==='End')        lastBtn.click();
        if (e.key==='+' || e.key==='=') zoomInBtn.click();
        if (e.key==='-' || e.key==='_') zoomOutBtn.click();
      });

      // refit on resize / orientation
      const refit = ()=> bestFitZoom();
      window.addEventListener('resize', refit);
      window.addEventListener('orientationchange', ()=> setTimeout(refit,120));

    }catch(err){
      console.error(err);
      setStatus("Failed to load PDF.");
      alert(err.message);
    }
  }

  await load();
})();
</script>
</body>
</html>
