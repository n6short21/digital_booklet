<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Flip Booklet</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/page-flip@2.0.7/dist/css/page-flip.css" />
<style>
  :root{--bg:#0f172a;--panel:#111827;--muted:#9ca3af;--text:#e5e7eb;--accent:#60a5fa}
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;overflow:hidden}

  .app{height:100%;display:grid;grid-template-rows:auto 1fr}
  header{background:var(--panel);border-bottom:1px solid #1f2937;padding:8px 12px;display:flex;justify-content:space-between;align-items:center}
  .muted{color:var(--muted);font-size:13px}

  .stage{position:relative;height:100%;padding:8px;display:flex;align-items:center;justify-content:center}

  /* Outer container that fills the iframe (no width cap) */
  #flipRoot{
    position:relative;
    width:100%;
    height:100%;
    margin:auto;
    border:1px solid #1f2937;
    border-radius:12px;
    background:#0b1220;
    overflow:hidden;
    display:flex;
    align-items:center;
    justify-content:center;
  }

  /* Padded frame (so shadows never clip) */
  #frame{position:relative;width:100%;height:100%;padding:16px 16px 72px 16px}

  /* Host for PageFlip (we size this precisely) */
  #bookWrap{
    position:absolute;inset:16px 16px 72px 16px;
    display:flex;align-items:center;justify-content:center;
  }

  /* replace your existing #book rule */
  #book{
    pointer-events:none;          /* still click-only nav */
    transform-origin: top center; /* scale from the top/center */
    will-change: transform;       /* smoother scaling */
  }

  #status{position:absolute;left:20px;top:14px;color:#9ca3af;font-size:13px}

  /* Click zones (left/right) */
  .nav-overlay{position:absolute;inset:16px 16px 72px 16px;z-index:3;display:grid;grid-template-columns:1fr 1fr}
  .zone{height:100%}
  .left{cursor:w-resize}
  .right{cursor:e-resize}

  /* Control dock (we measure its height for fit) */
  .dock{
    position:absolute;left:16px;right:16px;bottom:16px;z-index:4;
    display:flex;flex-wrap:wrap;gap:6px;justify-content:center;
    background:rgba(17,24,39,.82);backdrop-filter:blur(6px);
    border:1px solid #1f2937;border-radius:10px;padding:6px 8px
  }
  .btn{background:#0b1220;border:1px solid #1f2937;color:var(--text);
       padding:6px 10px;border-radius:8px;font-weight:600;cursor:pointer}
  .btn:hover{border-color:var(--accent)}
  .btn[disabled]{opacity:.55;cursor:not-allowed}
  .field{display:inline-flex;align-items:center;gap:6px}
  .page{width:56px;padding:6px 8px;border-radius:8px;border:1px solid #1f2937;background:#0b1220;color:var(--text);text-align:center}
  .sep{width:1px;height:22px;background:#1f2937;margin:0 4px;border-radius:1px}
  .meta{color:#cbd5e1;font-size:12px}

  @media (max-width:640px){
    .stage{padding:6px}
    #frame{padding:12px 12px 76px 12px}
    #bookWrap{inset:12px 12px 76px 12px}
    .dock{left:12px;right:12px;bottom:12px;padding:6px}
    .page{width:48px}
  }
</style>
</head>
<body>
<div class="app">
  <header>
    <strong>Flip Booklet</strong>
    <span class="muted" id="pageLabel">—</span>
  </header>

  <div class="stage">
    <div id="flipRoot">
      <div id="frame">
        <div id="bookWrap"><div id="book"></div></div>
        <div id="status">Loading…</div>

        <!-- click-only navigation -->
        <div class="nav-overlay">
          <div class="zone left"  id="zoneLeft"></div>
          <div class="zone right" id="zoneRight"></div>
        </div>

        <!-- controls -->
        <div class="dock" id="dock">
          <button class="btn" id="firstBtn" title="First page">⟸</button>
          <button class="btn" id="prevBtn"  title="Previous">←</button>
          <span class="field">
            <span class="meta">Page</span>
            <input class="page" id="pageInput" value="1" inputmode="numeric" />
            <span class="meta">of <span id="pageCount">—</span></span>
          </span>
          <button class="btn" id="nextBtn"  title="Next">→</button>
          <button class="btn" id="lastBtn"  title="Last page">⟹</button>
          <span class="sep"></span>
          <button class="btn" id="fitBtn"     title="Fit to view">Fit</button>
          <button class="btn" id="zoomOutBtn" title="Zoom out">–</button>
          <button class="btn" id="zoomInBtn"  title="Zoom in">+</button>
          <span class="meta" id="zoomLabel">100%</span>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/page-flip@2.0.7/dist/js/page-flip.browser.min.js"></script>
<script>
(async ()=>{
  const qs=new URLSearchParams(location.search);
  const SRC=qs.get("src")||"Sermon.pdf";

  // Elements
  const flipRoot=document.getElementById('flipRoot');
  const frameEl =document.getElementById('frame');
  const bookWrap=document.getElementById('bookWrap');
  const bookEl  =document.getElementById('book');
  const statusEl=document.getElementById('status');
  const dock    =document.getElementById('dock');
  const pageLabel=document.getElementById('pageLabel');
  const pageInput=document.getElementById('pageInput');
  const pageCount=document.getElementById('pageCount');
  const zoomLabel=document.getElementById('zoomLabel');
  const firstBtn=document.getElementById('firstBtn');
  const prevBtn =document.getElementById('prevBtn');
  const nextBtn =document.getElementById('nextBtn');
  const lastBtn =document.getElementById('lastBtn');
  const fitBtn  =document.getElementById('fitBtn');
  const zoomInBtn =document.getElementById('zoomInBtn');
  const zoomOutBtn=document.getElementById('zoomOutBtn');
  const zoneLeft=document.getElementById('zoneLeft');
  const zoneRight=document.getElementById('zoneRight');

  // pdf.js
  pdfjsLib.GlobalWorkerOptions.workerSrc="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";

  // State
  let pdfDoc=null, pageFlip=null, total=0;
  let base={w:800,h:1131};           // updated after first render
  let zoomFactor=1.0;                // relative to Fit (1.0 = fit exactly)
  const DPR=Math.min(2,window.devicePixelRatio||1);
  const setStatus=s=>statusEl.textContent=s||"";
  const clamp=(v,min,max)=>Math.max(min,Math.min(max,v));

  function updatePager(curr){
    pageInput.value=String(curr);
    firstBtn.disabled=curr<=1;
    prevBtn.disabled =curr<=1;
    nextBtn.disabled =curr>=total;
    lastBtn.disabled =curr>=total;
    pageLabel.textContent=`Page ${curr} / ${total}`;
  }

  // Compute usable size from the actual outer container + live paddings + dock height
  function availableSize(){
    const cs = window.getComputedStyle(frameEl);
    const padT = parseInt(cs.paddingTop)    || 0;
    const padR = parseInt(cs.paddingRight)  || 0;
    const padB = parseInt(cs.paddingBottom) || 0;
    const padL = parseInt(cs.paddingLeft)   || 0;

    const dockH = dock ? Math.ceil(dock.getBoundingClientRect().height) : 0;

    const cw = Math.max(200, flipRoot.clientWidth  - padL - padR - 2);
    const ch = Math.max(200, flipRoot.clientHeight - padT - padB - dockH - 2);
    return { cw, ch };
  }

  function getFitScale(){
    const {cw,ch}=availableSize();
    return Math.min(cw/base.w, ch/base.h);
  }

  function applyZoom(){
    if (!pageFlip) return;
  
    // Fit scale from the *live* container size
    const fit = getFitScale();
    const scale = fit * zoomFactor;      // 1.0 == exact fit
  
    // Keep PageFlip at its base (unscaled) size so animation stays crisp
    pageFlip.update({
      width:  base.w,
      height: base.h,
      usePortrait: true,
      showCover: false,
      size: "fixed"
    });
  
    // Visually scale the book; reserve the scaled box so nothing crops
    bookEl.style.transform = `scale(${scale})`;
    bookWrap.style.width   = Math.round(base.w * scale) + "px";
    bookWrap.style.height  = Math.round(base.h * scale) + "px";
  
    // Label reflects factor relative to Fit
    zoomLabel.textContent =
      Math.abs(zoomFactor - 1) < 0.01 ? "Fit" : Math.round(zoomFactor * 100) + "%";
  }


  function setZoomFactor(f){
    zoomFactor = clamp(f, 0.5, 2.5);
    requestAnimationFrame(applyZoom);   // defer until layout settles
  }

  async function renderPdfPageToImage(pdf, n){
    const page=await pdf.getPage(n);
    const viewport=page.getViewport({ scale:1.5*DPR });
    const c=document.createElement('canvas');
    c.width=viewport.width; c.height=viewport.height;
    await page.render({canvasContext:c.getContext('2d'),viewport}).promise;
    if(n===1) base={w:c.width,h:c.height};
    return c.toDataURL("image/png");
  }

  async function load(){
    try{
      setStatus("Loading PDF…");
      const res=await fetch(SRC,{credentials:"omit"});
      if(!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}`);
      const buf=await res.arrayBuffer();
      pdfDoc=await pdfjsLib.getDocument({data:buf}).promise;
      total=pdfDoc.numPages; pageCount.textContent=total;

      setStatus("Rendering pages…");
      const imgs=[];
      for(let i=1;i<=total;i++){
        imgs.push(await renderPdfPageToImage(pdfDoc,i));
        if(i%4===0) setStatus(`Rendering… ${i}/${total}`);
      }

      bookEl.innerHTML="";
      pageFlip=new St.PageFlip(bookEl,{
        width:base.w, height:base.h,
        usePortrait:true, showCover:false, size:"fixed",
        maxShadowOpacity:0.3, mobileScrollSupport:true
      });
      pageFlip.loadFromImages(imgs);
      pageFlip.on("flip", e=>updatePager(e.data+1));
      updatePager(1);

      // Initial fit
      zoomFactor = 1.0;
      applyZoom();
      setStatus("");

      // Pager
      firstBtn.onclick=()=>pageFlip.flip(0);
      prevBtn.onclick =()=>pageFlip.flipPrev();
      nextBtn.onclick =()=>pageFlip.flipNext();
      lastBtn.onclick =()=>pageFlip.flip(total-1);
      pageInput.addEventListener('keyup',e=>{
        if(e.key==='Enter'){
          const n = clamp(parseInt(pageInput.value||"1",10)||1,1,total);
          pageFlip.flip(n-1);
        }
      });
      pageInput.addEventListener('blur',()=>{
        const n = clamp(parseInt(pageInput.value||"1",10)||1,1,total);
        pageFlip.flip(n-1);
      });

      // Click zones
      zoneLeft.onclick =()=>pageFlip.flipPrev();
      zoneRight.onclick=()=>pageFlip.flipNext();

      // Zoom buttons
      fitBtn.onclick     = () => setZoomFactor(1.0);
      zoomInBtn.onclick  = () => setZoomFactor(zoomFactor + 0.1);
      zoomOutBtn.onclick = () => setZoomFactor(zoomFactor - 0.1);

      // --- Triggers that work inside Google Sites ---
      const ro = new ResizeObserver(() => applyZoom());
      ro.observe(flipRoot);
      ro.observe(bookWrap);
      ro.observe(dock);

      if (window.visualViewport) {
        window.visualViewport.addEventListener('resize', () => requestAnimationFrame(applyZoom));
      }

      window.addEventListener('orientationchange', () => setTimeout(applyZoom, 120));

      if (document.fonts && document.fonts.ready) document.fonts.ready.then(applyZoom);

      // Light polling guard for odd Sites transitions
      let lastW=0,lastH=0;
      setInterval(() => {
        const w=flipRoot.clientWidth, h=flipRoot.clientHeight;
        if (w!==lastW || h!==lastH) { lastW=w; lastH=h; applyZoom(); }
      }, 500);

    }catch(err){
      console.error(err); setStatus("Failed to load PDF."); alert(err.message);
    }
  }

  await load();
})();
</script>
</body>
</html>
